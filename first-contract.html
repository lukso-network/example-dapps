<html>

<head>
  <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.2.3/milligram.min.css">
  <link rel="stylesheet/less" type="text/css" href="styles.less" />
  <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/2.5.1/less.min.js"></script>
</head>

<body class="container" style="padding-top: 3%;">
  <p><a href="index.html">Back to Landing Page</a></p>
  <h2>Simple Store dApp</h2>

  <!-- Extension Notice -->
  <p class="note" style="display: block;">If you have multiple Web3 extensions installed, make sure to only enable one.
    Here
    you can find guides to manage
    <a href="https://support.google.com/chrome_webstore/answer/2664769?hl=en" target="_blank">Chrome</a> and
    <a href="https://support.mozilla.org/en-US/kb/disable-or-remove-add-ons#w_disabling-and-removing-extensions"
      target="_blank">Firefox</a> extensions.
  </p>

  <!-- Warnings -->
  <div class="warning" id="extension">
    MetaMask detected. To ensure the best expirience, install the
    <a href="https://docs.lukso.tech/guides/universal-profile/browser-extension/install-browser-extension">Universal
      Profile Browser Extension</a>. Otherwise, <a href="https://docs.lukso.tech/networks/l14-testnet">get
      LYXt</a> to set the value.
  </div>
  <p id="browser" class="warning">Please switch to a
    <a href="https://www.google.com/chrome/" target="_blank">Chrome</a> or
    <a href="https://www.mozilla.org/firefox/new/" target="_blank">Firefox</a> browser to use this dApp.
  </p>
  <p id="network" class="warning">
    Please <a href="https://docs.lukso.tech/networks/l14-testnet">swap to the LUKSO L14 testnetwork</a> in order to
    interact. </p>
  <p id="install" class="warning">
    Please install the
    <a href="https://docs.lukso.tech/guides/universal-profile/browser-extension/install-browser-extension"
      target="_blank">Universal Profile</a> or
    <a href="https://metamask.io/" target="_blank">MetaMask</a> extension to login.
  </p>
  <div id="login" style="display: none">
    <button id="loginbutton">Log in to your browser extension</button>
  </div>

  <hr />

  <!-- dApp Frontend -->
  <div class="row">
    <div class="column column-60">
      <label>Set Value</label>
      <input id="valueAmount" type="number" placeholder="i.e. 4500" />
      <div id="error" style="color: #9b4dca; padding-bottom: 10px;">Anyone can set/get values to/from the blockchain.
      </div>
      <button id="setValue">Set Value</button>
      <button id="getValue">Get Value</button>

      <br /><br />
      <div id="response" style="padding: 20px; border: 1px solid #9b4dca; word-wrap: break-word; min-height: 94px">
        Empty response window</div>
    </div>
    <div class="column column-40">
      <label>ABI</label>
      <textarea id="abi" style="height: 256px;"></textarea>
    </div>
  </div>

  <br /><br />

  <label>Solidity Code</label>

  <pre><code>
    pragma solidity >=0.7.0 <0.9.0;

    contract SimpleStore {

      function set(uint _value) public {
        value = _value;
      }

      function get() public view returns (uint) {
        return value;
      }

      uint value;
    }
  </code></pre>

  <hr />

  <b style="padding-bottom: 50px ">Repository File:</b></br><a
    href="https://github.com/lukso-network/example-dapps-ethjs/blob/master/first-contract.html"
    target="_blank">lukso-network/example-dapps-ethjs/first-contract.html</a>

  <!-- Web3 -->
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

  <!-- Connect Extension & Check Network -->
  <script src="./utils.js"></script>

  <!-- Main Function -->
  <script type="text/javascript">
    // Helper function to search for HTML elements
    let el = function (id) { return document.querySelector(id); };

    // ABI of the deployed contract
    const SimpleStoreABI = [{ "inputs": [], "name": "get", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "_value", "type": "uint256" }], "name": "set", "outputs": [], "stateMutability": "nonpayable", "type": "function" }];

    // Showing the ABI in the input field
    el('#abi').value = JSON.stringify(SimpleStoreABI, null, 2);

    // dApp Functionality
    async function dApp() {

      /**
       * Only start the dApp if: an extension is installed and right network connected 
       * Functions can be found in utils.js and return bool
       */
      if (await connectWeb3() && await checkNetwork()) {

        // Set up web3 library and get account
        const web3 = new Web3(window.ethereum);
        let account = await ethereum.request({ method: "eth_accounts" });

        // Deployed smart contract on L14
        let simpleStoreInstance = new web3.eth.Contract(SimpleStoreABI, '0xaA61d96cB849246Ebf3cf148e2f42F3FF216EA4D');

        // Add set button functionality
        el('#setValue').addEventListener('click', function () {
          let input = el('#valueAmount').value;

          // Check if user input is a valid
          if (input.length >= 1 && !isNaN(input)) {

            // Update response and error element
            el('#response').innerHTML = "Trying to set value...";
            el('#error').innerHTML = "Anyone can set/get values to/from the blockchain.";

            /**
             * Send set transaction from connected account.
             * Will use first connected address on 3rd party extensions
             */
            simpleStoreInstance.methods.set(input).send({ from: account[0] })
              .then(function (transactionReceipt) {
                el('#response').innerHTML = 'Value set. Your transaction hash is: ' + transactionReceipt.transactionHash;
              }).catch(e => { el('#response').innerHTML = 'Last transaction got canceled.'; });
          }

          // User input is invalid
          else {

            // Show invalid network notice
            el('#error').innerHTML = "You have to input a number before setting the value!"
          }
        });

        // Add get button functionality
        el('#getValue').addEventListener('click', function () {

          // Make a call to the smart contract and receive the stored value
          simpleStoreInstance.methods.get().call()
            .then(function (valueStored) {
              el('#response').innerHTML = 'The current value  stored in the smart contract is: ' + valueStored;
            });
        });
      }
    };

    // Start the dApp function
    dApp();
  </script>
</body>

</html>